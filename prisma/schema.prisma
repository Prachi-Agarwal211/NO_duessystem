// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CONFIGURATION TABLES
// ============================================================================

model ConfigSchool {
  id           String   @id @default(cuid())
  name         String   @unique
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  courses      ConfigCourse[]
  profiles     Profile[]

  @@map("config_schools")
}

model ConfigCourse {
  id           String   @id @default(cuid())
  schoolId     String   @map("school_id")
  name         String
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  school       ConfigSchool @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  branches     ConfigBranch[]
  profiles     Profile[]

  @@unique([schoolId, name])
  @@map("config_courses")
}

model ConfigBranch {
  id           String   @id @default(cuid())
  courseId     String   @map("course_id")
  name         String
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  course       ConfigCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  profiles     Profile[]

  @@unique([courseId, name])
  @@map("config_branches")
}

model Department {
  id                String   @id @default(cuid())
  name              String   @unique
  displayName       String?  @map("display_name")
  email             String?
  isSchoolSpecific  Boolean  @default(false) @map("is_school_specific")
  isActive          Boolean  @default(true) @map("is_active")
  displayOrder      Int      @default(0) @map("display_order")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  noDuesStatus      NoDuesStatus[]
  noDuesMessages    NoDuesMessage[]
  profiles          Profile[]

  @@map("departments")
}

model ConfigEmail {
  key         String   @id
  value       String
  description String?
  updatedBy   String?  @map("updated_by")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("config_emails")
}

model ConfigValidationRule {
  id        String   @id @default(cuid())
  type      String
  pattern   String
  message   String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("config_validation_rules")
}

model ConfigCountryCode {
  id          String   @id @default(cuid())
  countryName String   @map("country_name")
  countryCode String   @unique @map("country_code")
  dialCode    String   @map("dial_code")
  flagEmoji   String?  @map("flag_emoji")
  isActive    Boolean  @default(true) @map("is_active")
  displayOrder Int     @default(0) @map("display_order")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("config_country_codes")
}

model ConfigReapplicationRule {
  id          String   @id @default(cuid())
  ruleType    String   @map("rule_type")
  value       Int
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("config_reapplication_rules")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model Profile {
  id                    String   @id @default(cuid())
  email                 String   @unique
  fullName              String?  @map("full_name")
  registrationNo        String?  @map("registration_no")
  role                  String   @default("student")
  departmentName        String?  @map("department_name")
  assignedDepartmentIds String[] @default([]) @map("assigned_department_ids")
  schoolId              String?  @map("school_id")
  schoolIds             String[] @default([]) @map("school_ids")
  courseIds             String[] @default([]) @map("course_ids")
  branchIds             String[] @default([]) @map("branch_ids")
  isActive              Boolean  @default(true) @map("is_active")
  metadata              Json     @default("{}")::jsonb
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  school                ConfigSchool?  @relation(fields: [schoolId], references: [id])
  course                ConfigCourse?  @relation(fields: [courseIds], references: [id])
  branch                ConfigBranch?  @relation(fields: [branchIds], references: [id])
  department            Department?    @relation(fields: [departmentName], references: [name])
  noDuesForms           NoDuesForm[]
  auditLogs             AuditLog[]
  supportTickets        SupportTicket[]

  @@map("profiles")
}

// ============================================================================
// CORE WORKFLOW TABLES
// ============================================================================

model NoDuesForm {
  id                         String    @id @default(cuid())
  userId                     String?   @map("user_id")
  registrationNo             String    @map("registration_no")
  studentName                String    @map("student_name")
  parentName                 String?   @map("parent_name")
  admissionYear              String?   @map("admission_year")
  passingYear                String?   @map("passing_year")
  schoolId                   String?   @map("school_id")
  school                     String?
  courseId                   String?   @map("course_id")
  course                     String?
  branchId                   String?   @map("branch_id")
  branch                     String?
  countryCode                String?   @map("country_code")
  contactNo                  String?   @map("contact_no")
  personalEmail              String?   @map("personal_email")
  collegeEmail               String?   @map("college_email")
  email                      String?
  alumniScreenshotUrl        String?   @map("alumni_screenshot_url")
  status                     String    @default("pending")
  reapplicationOf            String?   @map("reapplication_of")
  reapplicationCount         Int       @default(0) @map("reapplication_count")
  lastReappliedAt            DateTime? @map("last_reapplied_at")
  studentReplyMessage       String?   @map("student_reply_message")
  isReapplication            Boolean   @default(false) @map("is_reapplication")
  maxReapplicationsOverride  Int?      @map("max_reapplications_override")
  rejectionContext           Json?     @map("rejection_context")
  rejectionReason            String?   @map("rejection_reason")
  finalCertificateGenerated  Boolean   @default(false) @map("final_certificate_generated")
  certificateUrl             String?   @map("certificate_url")
  blockchainHash             String?   @map("blockchain_hash")
  blockchainTx               String?   @map("blockchain_tx")
  blockchainBlock            Int?      @map("blockchain_block")
  blockchainTimestamp        DateTime? @map("blockchain_timestamp")
  blockchainVerified         Boolean   @default(false) @map("blockchain_verified")
  createdAt                  DateTime  @default(now()) @map("created_at")
  updatedAt                  DateTime  @updatedAt @map("updated_at")

  user                       Profile?          @relation(fields: [userId], references: [id])
  noDuesStatus               NoDuesStatus[]
  reapplicationHistory       NoDuesReapplicationHistory[]
  noDuesMessages             NoDuesMessage[]
  certificateVerifications   CertificateVerification[]
  studentData                StudentData?

  @@map("no_dues_forms")
}

model NoDuesStatus {
  id                  String    @id @default(cuid())
  formId              String    @map("form_id")
  departmentName      String    @map("department_name")
  status              String
  actionBy            String?   @map("action_by")
  actionAt            DateTime? @map("action_at")
  remarks             String?
  studentReplyMessage String?   @map("student_reply_message")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  form                NoDuesForm  @relation(fields: [formId], references: [id], onDelete: Cascade)
  department          Department  @relation(fields: [departmentName], references: [name])

  @@map("no_dues_status")
}

model NoDuesReapplicationHistory {
  id                  String    @id @default(cuid())
  formId              String    @map("form_id")
  reapplicationNumber  Int       @map("reapplication_number")
  reapplicationReason String    @map("reapplication_reason")
  studentReplyMessage String?   @map("student_reply_message")
  departmentResponses Json?     @map("department_responses")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  form                NoDuesForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("no_dues_reapplication_history")
}

model NoDuesMessage {
  id            String    @id @default(cuid())
  formId        String    @map("form_id")
  departmentName String    @map("department_name")
  message       String
  senderType    String    @map("sender_type")
  senderName    String    @map("sender_name")
  createdAt     DateTime  @default(now()) @map("created_at")
  isRead        Boolean   @default(false) @map("is_read")

  form          NoDuesForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  department    Department @relation(fields: [departmentName], references: [name])

  @@map("no_dues_messages")
}

// ============================================================================
// STUDENT DATA SYNC
// ============================================================================

model StudentData {
  id            String    @id @default(cuid())
  formId        String    @unique @map("form_id")
  registrationNo String  @map("registration_no")
  studentName   String    @map("student_name")
  parentName    String?   @map("parent_name")
  school        String
  course        String
  branch        String
  contactNo     String?   @map("contact_no")
  personalEmail String?   @map("personal_email")
  collegeEmail  String?   @map("college_email")
  admissionYear String?   @map("admission_year")
  passingYear   String?   @map("passing_year")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  updatedBy     String    @map("updated_by")

  form          NoDuesForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("student_data")
}

// ============================================================================
// CERTIFICATE & VERIFICATION
// ============================================================================

model CertificateVerification {
  id               String    @id @default(cuid())
  formId           String    @map("form_id")
  transactionId    String    @map("transaction_id")
  verificationResult String  @map("verification_result")
  tamperedFields   Json?     @map("tampered_fields")
  verifiedByIp     String    @map("verified_by_ip")
  verifiedAt       DateTime  @default(now()) @map("verified_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  form             NoDuesForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("certificate_verifications")
}

// ============================================================================
// SUPPORT SYSTEM
// ============================================================================

model SupportTicket {
  id           String    @id @default(cuid())
  ticketId     String    @unique @map("ticket_id")
  formId       String?   @map("form_id")
  registrationNo String? @map("registration_no")
  studentName  String?   @map("student_name")
  userEmail    String    @map("user_email")
  requesterType String   @map("requester_type")
  subject      String
  message      String
  status       String    @default("open")
  priority     String    @default("medium")
  assignedTo   String?   @map("assigned_to")
  isRead       Boolean   @default(false) @map("is_read")
  readAt       DateTime? @map("read_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  resolvedAt   DateTime? @map("resolved_at")
  resolvedBy   String?   @map("resolved_by")

  user         Profile?   @relation(fields: [userEmail], references: [email])

  @@map("support_tickets")
}

// ============================================================================
// LOGGING & AUDIT
// ============================================================================

model EmailLog {
  id            String    @id @default(cuid())
  emailType     String    @map("email_type")
  recipientEmail String   @map("recipient_email")
  subject       String
  body          String
  status        String
  errorMessage  String?   @map("error_message")
  sentAt        DateTime? @map("sent_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("email_logs")
}

model AuditLog {
  id         String    @id @default(cuid())
  action     String
  actorId    String    @map("actor_id")
  actorName  String    @map("actor_name")
  actorRole  String    @map("actor_role")
  targetId   String    @map("target_id")
  targetType String    @map("target_type")
  oldValues  Json?     @map("old_values")
  newValues  Json?     @map("new_values")
  ipAddress  String    @map("ip_address")
  userAgent  String    @map("user_agent")
  createdAt  DateTime  @default(now()) @map("created_at")

  actor      Profile?   @relation(fields: [actorId], references: [id])

  @@map("audit_logs")
}
