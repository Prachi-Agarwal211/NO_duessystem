# No Dues System - Full Flow Documentation: Submit Form Process

## Overview
The No Dues System allows students to submit applications for no-dues certificates, track their status, and reapply if rejected. This document outlines the complete flow from form submission to status tracking.

## Database Schema

### Core Tables
1. **student_data** - Master student database with 29,000+ records
   - Contains student details (registration_no, name, school, course, branch, etc.)
   - Used for auto-fetch functionality
   - Has indexes for performance optimization

2. **no_dues_forms** - Main form submissions
   - Stores student application data
   - Tracks status (pending, in_progress, rejected, completed, reapplied)
   - Manages reapplication logic (reapplication_count, last_reapplied_at, etc.)

3. **no_dues_status** - Department-wise approval tracking
   - Tracks each department's approval status for each form
   - Contains rejection reasons and action timestamps
   - Manages rejection counts per department

4. **no_dues_reapplication_history** - Reapplication tracking
   - Logs all reapplication attempts
   - Tracks per-department reapplications
   - Maintains student messages and edited fields

5. **departments** - System departments (library, hostel, accounts, etc.)
   - Defines which departments need to approve forms
   - Supports school-specific departments

6. **config_schools/courses/branches** - Academic structure
   - Hierarchical data for academic organization
   - Used for form validation and dropdowns

## Submit Form Flow

### 1. Form Rendering (src/app/student/submit-form/page.js)
- Displays the SubmitForm component
- Shows header, form surface, and instructions
- Includes back button navigation

### 2. Form Component (src/components/student/SubmitForm.jsx)
- **Initial State**: Empty form data with validation rules
- **Dynamic Configuration**: Loads schools, courses, branches via useFormConfig hook
- **Auto-fetch Feature**: 
  - Student enters registration number
  - Clicks "Auto-Fill" button
  - Calls `/api/student/lookup` API
  - Fetches student data from `student_data` table using `search_student_data` RPC
  - Auto-populates form fields with retrieved data

### 3. Form Submission Process
#### Client-Side Validation
- Checks all required fields
- Validates email formats and domains
- Ensures proper year formats (YYYY)
- Validates registration number format

#### API Submission (`/api/student` POST route)
1. **Rate Limiting**: Prevents spam submissions
2. **Zod Validation**: Server-side validation using predefined schemas
3. **Duplicate Check**: Ensures no existing form for the same registration number
4. **Foreign Key Validation**: 
   - Validates school_id, course_id, branch_id exist and are active
   - Ensures course belongs to selected school
   - Ensures branch belongs to selected course
5. **Data Insertion**: Creates record in `no_dues_forms` table
6. **Trigger Activation**: 
   - `handle_new_submission()` trigger creates entries in `no_dues_status` for all active departments
   - Sets initial status to 'pending' for all departments
7. **Confirmation**: Sends SMS notification to student

### 4. Status Tracking Flow

#### Check Status Page (src/app/student/check-status/page.js)
- **URL Parameter**: Accepts registration number via `?reg=` parameter
- **Auto-search**: Automatically searches if registration number is in URL
- **Form Display**: Shows student information card and status tracker

#### Status Tracker Component (src/components/student/StatusTracker.jsx)
- **API Call**: Fetches data from `/api/check-status`
- **Real-time Updates**: Subscribes to Supabase Realtime for instant updates
- **Visual Display**: Shows progress bar and department-wise status

#### Check Status API (`/api/check-status` GET route)
1. **Rate Limiting**: Prevents abuse
2. **Form Query**: Retrieves form data from `no_dues_forms`
3. **Department Status Query**: Gets all department statuses from `no_dues_status`
4. **Missing Status Creation**: If no status records exist, creates them for all departments
5. **Response**: Returns merged form and status data

### 5. Reapplication Flow

#### Global Reapplication (`/api/student/reapply` PUT route)
- **Eligibility Check**: Only for rejected forms that aren't completed
- **Limit Enforcement**: Maximum 5 reapplications globally
- **History Logging**: Records reapplication in `no_dues_reapplication_history`
- **Smart Reset**: Only resets rejected departments to 'pending', keeps approved ones
- **Notifications**: Emails only staff from rejected departments

#### Per-Department Reapplication (`/api/student/reapply/department` POST route)
- **Targeted Reapplication**: Reapply to specific department only
- **Per-Department Limits**: Maximum 5 attempts per department
- **Selective Reset**: Only resets the specific department
- **Targeted Notifications**: Emails only staff from that department

### 6. Data Flow Summary

#### Input → Processing → Output
```
Student enters registration number
    ↓
Auto-fetch API (/api/student/lookup) queries student_data table
    ↓
RPC function search_student_data finds matching record
    ↓
Form auto-populated with student data
    ↓
Student submits form
    ↓
API validates and inserts into no_dues_forms
    ↓
Trigger creates department status records in no_dues_status
    ↓
Form status becomes "pending"
    ↓
Departments review and approve/reject
    ↓
Individual department statuses update
    ↓
Overall form status updates based on all department statuses
    ↓
Student can track status in real-time
    ↓
If rejected, student can reapply (global or per-dept)
    ↓
Reapplication creates new history record and resets relevant statuses
```

### 7. Key Features

#### Auto-Fetch Functionality
- Students can enter registration number
- System auto-populates form with stored student data
- Reduces manual entry errors

#### Cascading Dropdowns
- School → Course → Branch hierarchy
- Dynamic loading based on selections
- Proper validation relationships

#### Real-time Status Updates
- Live updates via Supabase Realtime
- Instant status reflection without page refresh
- Progress tracking visualization

#### Smart Reapplication
- Global reapplication affects all rejected departments
- Per-department reapplication targets specific departments
- Separate limits for global and per-dept attempts
- Maintains approved department statuses during reapplication

#### Comprehensive Tracking
- Detailed reapplication history
- Per-department rejection tracking
- Cascade rejection context (when one department rejection affects others)

This system provides a robust, scalable solution for managing no-dues applications with proper validation, real-time updates, and flexible reapplication options.